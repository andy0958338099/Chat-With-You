# Chat-With-You 聊天應用開發流程書

## 專案概述

**專案名稱**: Chat-With-You  
**專案類型**: 多平台社群聊天應用（Web、iOS、Android）  
**UI 風格**: Apple 風格，簡潔、極簡主義設計  
**核心功能**: 實時聊天、AI 輔助功能、自定義 AI 機器人、好友管理、支付系統  

## 一、準備階段

### 1. 環境設置
- [ ] 確認 Node.js v20.2.1 安裝
- [ ] 安裝 Next.js 14 框架
- [ ] 配置 TypeScript 環境
- [ ] 安裝並設置 Tailwind CSS
- [ ] 整合 Chakra UI 或 Shadcn UI 組件庫
- [ ] 配置 ESLint 和 Prettier
- [ ] 初始化 Git 版本控制
- [ ] 建立 GitHub 倉庫

### 2. 項目結構規劃
- [ ] 設計文件夾結構（遵循 Next.js 14 App Router 規範）
- [ ] 建立核心目錄：`app/`, `components/`, `services/`, `utils/`, `hooks/`
- [ ] 規劃路由策略
- [ ] 設計狀態管理方案
- [ ] 建立環境變數配置（開發、測試、生產）

### 3. 設計系統建立
- [ ] 定義色彩系統（主色、輔助色、狀態色）
- [ ] 建立排版系統（字體、大小、行高）
- [ ] 設計組件庫（按鈕、輸入框、卡片等）
- [ ] 創建響應式佈局系統
- [ ] 定義動畫和過渡效果
- [ ] 實現 Apple 風格設計元素（白色背景、輕微陰影、圓角元素）

## 二、認證系統實現

### 1. 數據庫配置
- [ ] 設置 Supabase 專案
- [ ] 配置認證表（users, profiles, sessions）
- [ ] 設置行級安全策略 (RLS)
- [ ] 建立認證相關的數據觸發器
- [ ] 配置 OAuth 提供商設置（Google、Facebook、Apple）

### 2. 認證服務開發
- [ ] 建立認證 API 服務層（註冊、登入、登出）
- [ ] 實現 JWT 令牌管理（存儲、刷新、驗證）
- [ ] 開發多因素認證功能
- [ ] 實現密碼重設流程
- [ ] 建立社交媒體登入整合（Google、Facebook、Apple）

### 3. 認證界面開發
- [ ] 設計並實現登入頁面
- [ ] 創建註冊表單與驗證
- [ ] 開發密碼恢復界面
- [ ] 實現社交媒體登入按鈕
- [ ] 建立用戶引導頁面（Onboarding）
- [ ] 開發認證路由守衛（ProtectedRoute）

## 三、聊天功能實現

### 1. 聊天數據模型
- [ ] 設計聊天表結構（conversations, messages, participants）
- [ ] 實現消息類型系統（文字、圖片、視頻、語音）
- [ ] 建立消息狀態追蹤（發送中、已發送、已讀）
- [ ] 設計消息同步機制
- [ ] 配置 Supabase Realtime 通道

### 2. 聊天服務層
- [ ] 開發聊天 API 服務（發送、接收、同步）
- [ ] 實現實時通信（WebSocket 或 Supabase Realtime）
- [ ] 建立離線消息隊列
- [ ] 開發消息加密功能
- [ ] 實現訊息歷史記錄與分頁加載

### 3. 聊天界面開發
- [ ] 設計聊天列表組件
- [ ] 實現聊天對話窗口
- [ ] 開發消息輸入區（文字、表情、附件）
- [ ] 創建消息氣泡組件（自適應大小、狀態顯示）
- [ ] 實現消息加載動畫和狀態指示器
- [ ] 建立離線模式顯示
- [ ] 開發消息通知系統

## 四、AI 功能整合

### 1. AI 服務配置
- [ ] 設置 Deepseek API 連接
- [ ] 配置 OpenAI API 連接（備選）
- [ ] 實現 API 密鑰安全管理
- [ ] 建立 AI 請求限流機制
- [ ] 開發 AI 服務錯誤處理策略

### 2. AI 助手功能
- [ ] 實現上下文感知建議
- [ ] 開發語調調整功能
- [ ] 建立智能回覆生成
- [ ] 實現多語言翻譯功能
- [ ] 開發情感分析功能

### 3. 自定義 AI 機器人系統
- [ ] 設計機器人創建流程
- [ ] 實現知識庫類機器人
- [ ] 開發指令類機器人
- [ ] 建立自定義類機器人
- [ ] 實現機器人訓練和優化功能
- [ ] 開發機器人市場界面
- [ ] 建立機器人評分和評論系統

## 五、好友管理系統

### 1. 好友數據模型
- [ ] 設計好友關係表（friends, friend_requests）
- [ ] 實現好友狀態系統（待接受、已接受、已拒絕、已封鎖）
- [ ] 建立好友分組功能
- [ ] 開發好友隱私設置模型

### 2. 好友服務層
- [ ] 開發好友 API 服務（添加、接受、拒絕、刪除）
- [ ] 實現好友搜索功能（用戶名、電子郵件、手機號）
- [ ] 建立 QR 碼生成和掃描服務
- [ ] 開發好友推薦算法
- [ ] 實現好友通知系統

### 3. 好友界面開發
- [ ] 設計聯繫人列表界面
- [ ] 實現好友請求管理頁面
- [ ] 開發好友搜索組件
- [ ] 創建 QR 碼添加好友功能
- [ ] 建立好友資料頁面
- [ ] 實現好友分組管理界面

## 六、支付系統實現

### 1. 積分系統
- [ ] 設計積分數據模型（credits, usage_history）
- [ ] 實現積分計算和消費邏輯
- [ ] 建立積分余額提醒功能
- [ ] 開發積分使用統計報表
- [ ] 實現積分自動充值機制

### 2. 支付集成
- [ ] 整合街口支付 API
- [ ] 配置 Line Pay API
- [ ] 實現支付回調處理
- [ ] 開發交易記錄系統
- [ ] 建立發票生成功能
- [ ] 實現退款處理機制

### 3. 訂閱管理
- [ ] 設計訂閱計劃模型
- [ ] 實現訂閱流程
- [ ] 開發訂閱狀態管理
- [ ] 建立續訂提醒功能
- [ ] 實現訂閱升級/降級邏輯
- [ ] 開發訂閱統計報表

## 七、文件存儲系統

### 1. Cloudinary 集成
- [ ] 配置 Cloudinary 環境
- [ ] 實現圖片上傳服務
- [ ] 開發文件管理系統
- [ ] 建立媒體優化策略（壓縮、裁剪）
- [ ] 實現文件共享功能

### 2. 本地存儲管理
- [ ] 設計離線文件存儲策略
- [ ] 實現臨時文件清理機制
- [ ] 開發加密存儲功能
- [ ] 建立文件同步系統
- [ ] 實現存儲空間管理

## 八、移動端開發

### 1. Expo 配置
- [ ] 設置 Expo 開發環境
- [ ] 配置 Android 和 iOS 構建設置
- [ ] 實現推送通知功能
- [ ] 開發離線功能支持
- [ ] 配置深度鏈接功能

### 2. 移動端適配
- [ ] 調整佈局以適應不同螢幕尺寸
- [ ] 優化移動端手勢操作
- [ ] 實現移動端特定功能（相機、麥克風、位置）
- [ ] 開發省電模式
- [ ] 建立移動端性能優化

### 3. 平台特定功能
- [ ] iOS 專用功能（Apple Sign In、ApplePay）
- [ ] Android 專用功能（Google Play Services 集成）
- [ ] 實現 App Clips 和 Instant Apps
- [ ] 開發小工具（Widgets）
- [ ] 建立手錶 App 集成

## 九、測試與優化

### 1. 單元測試
- [ ] 配置測試框架（Jest、React Testing Library）
- [ ] 為核心服務編寫單元測試
- [ ] 實現組件測試
- [ ] 開發工具函數測試
- [ ] 建立 API 測試

### 2. 整合測試
- [ ] 設置端到端測試環境（Cypress）
- [ ] 實現認證流程測試
- [ ] 開發聊天功能測試
- [ ] 建立支付流程測試
- [ ] 實現好友管理測試

### 3. 性能優化
- [ ] 進行代碼拆分
- [ ] 實現懶加載策略
- [ ] 開發圖片和媒體優化
- [ ] 建立緩存策略
- [ ] 實現服務端渲染和靜態生成優化
- [ ] 進行 Web Vitals 優化

## 十、部署與發布

### 1. 前端部署
- [ ] 配置 Netlify 部署設置
- [ ] 實現持續集成/持續部署 (CI/CD)
- [ ] 建立環境變數管理
- [ ] 開發自動化測試流程
- [ ] 配置自定義域名和 SSL

### 2. 後端服務部署
- [ ] 部署 Supabase 數據庫和功能
- [ ] 配置 API 服務器部署
- [ ] 實現數據庫備份策略
- [ ] 建立監控系統
- [ ] 開發錯誤報告機制

### 3. 應用發布
- [ ] 準備 App Store 發布資料
- [ ] 配置 Google Play 上架信息
- [ ] 實現應用更新機制
- [ ] 建立版本控制策略
- [ ] 開發用戶反饋收集系統

---

## 當前進度

### 已完成
- 前期規劃和需求分析
- 技術棧選擇
- 初步設計系統
- 環境配置
- 認證系統開發
- 基礎 UI 組件開發
- 個人資料頁面開發
- 底部導航功能連結實現
- 頂部導航用戶頭像實現
- 驗證所有「我的」相關導航功能
- 修正 Next.js 路由整合問題
- 頁面重構以適應 Next.js 架構
- 個人資料頁面功能增強
- 積分系統基礎實現

### 正在進行
- 聊天功能開發
- 好友管理系統實現

### 下一步
1. 完成即時聊天功能實現
   - 建立聊天列表界面
   - 開發聊天室功能
   - 實現消息發送與接收
   - 集成表情符號和檔案分享功能

2. 開始 AI 功能整合
   - 設置 AI 服務連接
   - 開發智能回覆功能
   - 建立自定義 AI 助手系統

### 最近完成的功能：個人資料頁面功能增強

1. **個人資料頁面 Supabase 整合**
   - 完成個人資料頁面與 Supabase 數據庫的整合
   - 實現真實用戶數據顯示（姓名、ID、頭像等）
   - 添加 ID 複製功能
   - 直觀顯示用戶點數和 AI 助手數量
   - 實現登出功能，並重定向到登入頁面
   - 添加動態加載狀態

2. **編輯個人資料功能**
   - 創建個人資料編輯頁面
   - 實現用戶信息表單編輯
   - 添加頭像上傳功能，集成 Supabase Storage
   - 實現會員類型顯示與升級提示
   - 添加錯誤處理和表單驗證
   - 集成返回功能，優化用戶體驗

3. **積分系統實現**
   - 設計並實現積分餘額頁面
   - 顯示用戶當前積分和使用記錄
   - 創建積分充值入口
   - 實現積分套餐選擇頁面
   - 添加支付方式選擇（信用卡、Line Pay、街口支付）
   - 開發充值成功頁面，提供導航回積分頁面的功能
   - 實現積分交易記錄顯示，包含交易類型、金額和時間

4. **路由與導航優化**
   - 所有新頁面均採用 Next.js App Router 架構
   - 確保所有頁面間的導航無縫銜接
   - 優化返回按鈕邏輯，確保用戶可以方便返回上一頁
   - 統一底部導航在所有頁面的顯示
   - 優化頂部導航頭像顯示，根據用戶是否有自訂頭像做出相應處理

5. **UI/UX 改進**
   - 全面優化加載狀態顯示
   - 添加表單錯誤提示和成功反饋
   - 改進按鈕和互動元素的視覺體驗
   - 確保各頁面的視覺風格一致性
   - 改進積分充值流程的用戶體驗
   - 添加充值成功後的自動跳轉和倒計時功能

6. **數據模型擴展**
   - 擴展用戶資料模型，添加頭像和積分欄位
   - 設計並實現積分記錄表結構
   - 創建積分變動歷史記錄表，追蹤所有積分交易
   - 實現數據關聯，確保各表之間數據一致性
   - 添加即時更新邏輯，確保用戶資料變更立即反映在界面上

### 最近完成的功能：頁面整合與 Next.js 適配

1. **個人資料頁面**
   - 已完成 Profile.tsx 頁面，顯示用戶個人資訊、AI 助手數量和積分餘額
   - 整合 Supabase 資料庫讀取真實用戶資料
   - 實現頭像顯示、用戶 ID 複製功能
   - 添加邀請好友功能，生成隨機邀請碼
   - 完成登出功能，清除用戶狀態
   - 重構為 Next.js 兼容的 Client Component

2. **聯絡人頁面**
   - 完成 Contacts 頁面，並加入字母索引功能
   - 支持搜索聯絡人
   - 重構為 Next.js 兼容的 Client Component
   - 統一使用 TailwindCSS 樣式

3. **AI 助手頁面**
   - 實現 AI 助手列表顯示
   - 添加分類標籤功能
   - 實現網格布局展示各類助手
   - 重構為 Next.js 兼容的 Client Component
   - 統一使用 TailwindCSS 樣式

4. **路由修正與導航優化**
   - 修正了 App.tsx 中路由設置，確保嵌套路由正確工作
   - 更新了底部導航的路徑處理邏輯，解決404問題
   - 調整了頁面間的導航邏輯，確保頁面切換流暢
   - 修正了路徑前綴問題，確保相對路徑正確執行
   - 更新 EditProfile 返回邏輯，保證能回到個人資料頁面
   - 新增右上角用戶頭像，點擊可快速導航至個人頁面
   - 驗證底部導航「我的」按鈕正確連結到 Profile 頁面
   - 確保兩個導航入口（右上角頭像和底部「我的」按鈕）保持一致引導至相同頁面
   - 整合 Next.js 頁面路由系統，確保所有導航路徑正確工作
   - 解決 React Router 與 Next.js 混合使用導致的 404 錯誤問題
   - 創建缺失的 Next.js 頁面並標記為客戶端組件

5. **Next.js 技術整合**
   - 將 React Router 導航模式改為 Next.js Link 組件
   - 更新 Supabase 環境變數格式，從 VITE_ 前綴改為 Next.js 格式
   - 解決客戶端組件依賴問題，添加 "use client" 指令
   - 安裝缺少的 @tabler/icons-react 依賴
   - 將 Chakra UI 組件庫替換為原生 TailwindCSS 實現，避免兼容性問題

6. **UI/UX 優化**
   - 所有頁面統一使用繁體中文
   - 添加載入狀態和錯誤處理
   - 實現無縫的頁面導航和轉場
   - 使用 Toast 提供操作反饋
   - 優化表單交互體驗
   - 頂部導航標準化，實現一致的頭像顯示和點擊功能
   - 底部導航加強直觀性，確保用戶可以輕鬆辨識並導航至關鍵功能區域
   - 統一各頁面樣式風格，保持一致的視覺體驗

### 項目注意事項
- 所有敏感密鑰（API 密鑰、服務令牌）必須存儲在環境變數中，不要直接寫入代碼
- 使用 Supabase URL 和匿名密鑰 (https://tfoszbtbrhyecfykymka.supabase.co)
- 遵循 TypeScript 最佳實踐，確保強類型系統
- UI 設計必須符合 Apple 風格指南，保持簡潔、極簡的設計理念
- 所有 API 和支付功能必須實現適當的錯誤處理和重試機制
- 代碼中應包含繁體中文註釋，保持文檔清晰明了
- 定期審核和更新這個流程書，保持與實際開發進度一致
- React Router 路由配置需要特別注意路徑前綴，避免404錯誤出現
- 一致性是關鍵：確保相同功能的不同導航入口始終指向相同頁面
- 由於項目使用 Next.js 框架，需確保 Next.js 頁面路由系統與 React 組件正確整合
- Next.js Client Components 必須在文件頂部添加 "use client" 指令
- 積分系統需要仔細設計資料模型，確保所有交易記錄可追蹤
- 用戶頭像上傳功能需要處理檔案大小限制和格式檢查

## 環境變數配置修改

### 已完成
- 將 Vite 專案的環境變數配置改為 Next.js 格式
- 創建 `.env.local` 文件以支援 Next.js 環境變數
- 更新 `next.config.mjs` 以確保環境變數正確傳遞到前端
- 修改 `src/services/supabase.ts` 文件，改用 `process.env` 存取環境變數

### 技術細節
1. **環境變數命名轉換**：
   - Vite: `import.meta.env.VITE_XXX`
   - Next.js: `process.env.NEXT_PUBLIC_XXX`

2. **檔案修改**：
   - 創建了 `.env.local` 檔案，將所有環境變數以 `NEXT_PUBLIC_` 開頭
   - 更新了 `next.config.mjs` 檔案，添加 `env` 配置項目
   - 修改了 `supabase.ts` 中的環境變數存取方式

3. **問題解決**：
   - 修正了 `TypeError: Cannot read properties of undefined (reading 'VITE_SUPABASE_URL')` 錯誤
   - 確保 Supabase 客戶端可正確初始化

### 下一步
- 重新啟動開發伺服器進行測試
- 檢查 Supabase 連接是否正常運作
- 確認所有依賴環境變數的功能正常工作

## 底部導航修復與 Next.js 整合

### 已完成
- 創建 `app/components/BottomNavigation.tsx` 作為 Next.js 版本的底部導航
- 將底部導航組件整合到所有主要頁面：儀表板、聯絡人、AI 助手和個人資料
- 修正了底部導航的路徑和活動狀態偵測
- 解決了 "我的" 按鈕點擊後跳轉的問題

### 技術細節
1. **React Router 到 Next.js Link 轉換**：
   - 將 `useLocation` 和 `useNavigate` 替換為 Next.js 的 `usePathname`
   - 使用 Next.js 的 `Link` 組件進行路由導航
   - 重新實現路徑匹配邏輯以適應 Next.js 的路由系統

2. **修正路徑問題**：
   - 儀表板路徑: `/dashboard`
   - 聯絡人路徑: `/contacts`
   - AI 助手路徑: `/ai`
   - 個人資料路徑: `/profile`
   - 確保正確檢測當前活動的導航項目

3. **核心功能頁面重構**：
   - 為每個路徑創建對應的 Next.js 頁面
   - 將所有頁面標記為客戶端組件 (`"use client"`)
   - 導入相同的底部導航組件以保持一致性
   - 實現相同的設計風格和用戶體驗

4. **優化用戶體驗**：
   - 添加 `pb-16` 類防止內容被底部導航遮擋
   - 保持底部導航固定在螢幕底部，始終可見
   - 根據當前路徑高亮顯示對應的導航按鈕
   - 確保所有連結和圖標都能正確工作

### 下一步
- 為聯絡人頁面實現更完整的搜索和排序功能
- 優化 AI 助手頁面的性能和用戶界面
- 實現更多連接頁面之間的功能，例如從聯絡人到聊天的流暢轉換
- 添加適當的頁面過渡動畫提升用戶體驗
